// Wait for the DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    // AppKit configuration with your Project ID
    const appkitProjectId = '287cdf73678b3347707785914cad8b6a';
    let solanaConnection = null;
    let publicKey = null;
    let walletConnected = false;
    
    // UI Elements
    const walletConnectBtn = document.getElementById('wallet-connect-btn');
    const walletConnectPromptBtn = document.getElementById('wallet-connect-prompt-btn');
    const walletStatus = document.getElementById('wallet-status');
    const walletAddress = document.getElementById('wallet-address');
    const disconnectBtn = document.getElementById('disconnect-btn');
    const connectPrompt = document.getElementById('connect-prompt');
    const purchaseForm = document.querySelector('.purchase-form');
    const tokenAmountInput = document.getElementById('token-amount');
    const totalCostDisplay = document.getElementById('total-cost');
    const buyBtn = document.getElementById('buy-btn');
    const transactionModal = document.getElementById('transaction-modal');
    const closeModalBtn = document.querySelector('.close-btn');
    const transactionStatus = document.getElementById('transaction-status');
    
    // Initialize Solana connection
    function initializeSolana() {
        try {
            // Connect to Solana devnet
            solanaConnection = new solanaWeb3.Connection(
                solanaWeb3.clusterApiUrl('devnet'),
                'confirmed'
            );
            console.log('Connected to Solana devnet');
        } catch (error) {
            console.error('Failed to connect to Solana network:', error);
        }
    }
    
    // Connect wallet using WalletConnect with AppKit
    async function connectWallet() {
        try {
            if (typeof window.ethereum !== 'undefined') {
                // For browsers with Ethereum providers (MetaMask, etc.)
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                handleWalletConnection(accounts[0]);
            } else {
                // Use WalletConnect via AppKit
                const walletConnectProvider = new WalletConnectProvider.default({
                    projectId: appkitProjectId,
                    chains: [1], // Ethereum Mainnet as fallback
                    showQrModal: true,
                    qrModalOptions: {
                        themeMode: "dark"
                    }
                });
                
                // Subscribe to connect event
                walletConnectProvider.on("connect", (error, payload) => {
                    if (error) {
                        console.error("WalletConnect connection error:", error);
                        return;
                    }
                    const { accounts } = payload.params[0];
                    if (accounts && accounts.length > 0) {
                        handleWalletConnection(accounts[0]);
                    }
                });
                
                await walletConnectProvider.enable();
            }
        } catch (error) {
            console.error('Error connecting wallet:', error);
        }
    }
    
    // Handle successful wallet connection
    function handleWalletConnection(address) {
        publicKey = address;
        walletConnected = true;
        
        // Update UI to show connected state
        walletConnectBtn.classList.add('hidden');
        walletStatus.classList.remove('hidden');
        
        // Format and display wallet address
        const formattedAddress = formatAddress(address);
        walletAddress.textContent = formattedAddress;
        
        // Update purchase section
        if (connectPrompt && purchaseForm) {
            connectPrompt.classList.add('hidden');
            purchaseForm.classList.remove('hidden');
        }
        
        console.log(`Connected to wallet: ${address}`);
    }
    
    // Disconnect wallet
    function disconnectWallet() {
        publicKey = null;
        walletConnected = false;
        
        // Update UI to show disconnected state
        walletConnectBtn.classList.remove('hidden');
        walletStatus.classList.add('hidden');
        
        // Update purchase section
        if (connectPrompt && purchaseForm) {
            connectPrompt.classList.remove('hidden');
            purchaseForm.classList.add('hidden');
        }
        
        console.log('Disconnected from wallet');
    }
    
    // Format wallet address for display
    function formatAddress(address) {
        if (!address) return '';
        return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
    }
    
    // Calculate total cost based on token amount
    function calculateTotalCost() {
        const amount = parseInt(tokenAmountInput.value) || 0;
        const price = 0.007; // Current phase price
        const total = (amount * price).toFixed(6);
        totalCostDisplay.textContent = `${total} SOL`;
    }
    
    // Buy tokens
    async function buyTokens() {
        if (!walletConnected) {
            alert('Please connect your wallet first');
            return;
        }
        
        const amount = parseInt(tokenAmountInput.value) || 0;
        if (amount <= 0) {
            alert('Please enter a valid amount of tokens');
            return;
        }
        
        const price = 0.007; // Current phase price
        const totalCost = (amount * price).toFixed(6);
        
        // Show transaction modal
        transactionModal.style.display = 'block';
        transactionStatus.innerHTML = `
            <div style="text-align: center;">
                <div style="margin-bottom: 20px;">
                    <div class="loading-spinner"></div>
                </div>
                <h3 style="color: #FFD700; margin-bottom: 15px;">Processing Transaction</h3>
                <p>Purchasing ${amount} MoonChimp tokens for ${totalCost} SOL</p>
                <p style="color: rgba(255,255,255,0.7); margin-top: 15px;">Please confirm the transaction in your wallet...</p>
            </div>
        `;
        
        try {
            // Simulate transaction delay
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // Transaction success
            transactionStatus.innerHTML = `
                <div style="text-align: center;">
                    <div style="margin-bottom: 20px;">
                        <div class="success-checkmark">✓</div>
                    </div>
                    <h3 style="color: #4CAF50; margin-bottom: 15px;">Transaction Successful!</h3>
                    <p>You have successfully purchased ${amount} MoonChimp tokens for ${totalCost} SOL</p>
                    <p style="color: rgba(255,255,255,0.7); margin-top: 15px;">Tokens will be available in your wallet soon.</p>
                </div>
            `;
            
            // Update the UI to show the new token sold count
            setTimeout(() => {
                // This would be replaced with actual blockchain data in production
                const tokensSoldElement = document.getElementById('tokens-sold');
                const currentSold = parseInt(tokensSoldElement.textContent.split('/')[0]);
                const total = parseInt(tokensSoldElement.textContent.split('/')[1]);
                const newSold = currentSold + amount;
                tokensSoldElement.textContent = `${newSold}/${total}`;
                
                // Update the progress bar
                const progressBar = document.querySelector('.active .progress-bar');
                const newWidth = (newSold / total) * 100;
                progressBar.style.width = `${newWidth}%`;
            }, 2000);
            
        } catch (error) {
            console.error('Transaction failed:', error);
            
            // Transaction failure
            transactionStatus.innerHTML = `
                <div style="text-align: center;">
                    <div style="margin-bottom: 20px;">
                        <div class="error-x">✗</div>
                    </div>
                    <h3 style="color: #e63946; margin-bottom: 15px;">Transaction Failed</h3>
                    <p>There was an error processing your transaction.</p>
                    <p style="color: rgba(255,255,255,0.7); margin-top: 15px;">Please try again later.</p>
                </div>
            `;
        }
    }
    
    // Close the transaction modal
    function closeModal() {
        transactionModal.style.display = 'none';
    }
    
    // Add event listeners
    if (walletConnectBtn) {
        walletConnectBtn.addEventListener('click', connectWallet);
    }
    
    if (walletConnectPromptBtn) {
        walletConnectPromptBtn.addEventListener('click', connectWallet);
    }
    
    if (disconnectBtn) {
        disconnectBtn.addEventListener('click', disconnectWallet);
    }
    
    if (tokenAmountInput) {
        tokenAmountInput.addEventListener('input', calculateTotalCost);
    }
    
    if (buyBtn) {
        buyBtn.addEventListener('click', buyTokens);
    }
    
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeModal);
        
        // Also close modal when clicking outside of it
        window.addEventListener('click', function(event) {
            if (event.target === transactionModal) {
                closeModal();
            }
        });
    }
    
    // Initialize Solana connection
    initializeSolana();
    
    // Initial UI setup
    if (connectPrompt && purchaseForm) {
        connectPrompt.style.display = 'block';
        purchaseForm.style.display = 'none';
    }
    
    // Calculate initial total cost
    calculateTotalCost();
    
    // Add styles for the loading spinner and success/error indicators
    const style = document.createElement('style');
    style.textContent = `
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #FFD700;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .success-checkmark {
            font-size: 50px;
            color: #4CAF50;
        }
        
        .error-x {
            font-size: 50px;
            color: #e63946;
        }
    `;
    document.head.appendChild(style);
    
    // Add countdown timer functionality
    const countdownDate = new Date("May 31, 2025 00:00:00").getTime();
    
    function updateCountdown() {
        const now = new Date().getTime();
        const distance = countdownDate - now;
        
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        // Update the display
        document.getElementById("time-remaining").textContent = `${days} Days`;
        
        // If the countdown is over
        if (distance < 0) {
            clearInterval(countdownInterval);
            document.getElementById("time-remaining").textContent = "ENDED";
        }
    }
    
    // Update the countdown every second
    const countdownInterval = setInterval(updateCountdown, 1000);
    updateCountdown(); // Initial call
});
